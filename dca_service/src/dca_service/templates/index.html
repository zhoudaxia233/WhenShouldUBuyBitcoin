<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - Transaction History</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .container { max-width: 1200px; }
        .status-badge { font-size: 0.9em; }
    </style>
</head>
<body>
    <div class="container">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1>{{ project_name }}</h1>
            <div>
                <a href="/strategy" class="btn btn-outline-secondary me-2">Strategy Config</a>
                <button id="simulateBtn" class="btn btn-primary">Simulate Transaction</button>
            </div>
        </header>

        <!-- Holdings & Target Section (Phase 7) -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white">
                <h5 class="mb-0">Holdings & Target</h5>
            </div>
            <div class="card-body">
                <div id="holdingsError" class="alert alert-warning d-none">
                    Binance not connected. Please configure your API key below.
                </div>
                <div id="holdingsContent" class="d-none">
                    <div class="row text-center mb-3">
                        <div class="col-md-4">
                            <div class="text-muted small">BTC Balance</div>
                            <div class="h4" id="btcBalance">--</div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-muted small">Quote Balance (<span id="quoteAsset">USDC</span>)</div>
                            <div class="h4" id="quoteBalance">--</div>
                        </div>
                        <div class="col-md-4">
                            <div class="text-muted small">Target Progress</div>
                            <div class="h4" id="progressPercent">--%</div>
                            <div class="text-muted small" id="targetAmount">Target: -- BTC</div>
                        </div>
                    </div>
                    <div class="progress" style="height: 20px;">
                        <div id="progressBar" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- DCA Control Section -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">DCA Preview & Control</h5>
                <div>
                    <span id="dataSourceBadge" class="badge bg-secondary me-2">Source: --</span>
                    <span id="scheduleDisplay" class="badge bg-info text-dark me-2">Loading Schedule...</span>
                    <button id="refreshBtn" class="btn btn-sm btn-outline-primary" title="Refresh preview">
                        üîÑ Refresh
                    </button>
                </div>
            </div>
            <div class="card-body">
                <div id="metricsWarning" class="alert alert-danger d-none">
                    <strong>Warning:</strong> Metrics are stale or unavailable. DCA execution disabled.
                </div>
                <div class="row text-center mb-3">
                    <div class="col-md-3">
                        <div class="text-muted small">AHR999 Index</div>
                        <div class="h4" id="previewAhr">--</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted small">Current Price</div>
                        <div class="h4" id="previewPrice">--</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted small">Strategy Band</div>
                        <div class="h4" id="previewBand">--</div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-muted small">Suggested Action</div>
                        <div class="h4 text-primary" id="previewAction">--</div>
                    </div>
                </div>
                
                <div class="alert alert-light border mb-3" id="previewReasonBox">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <strong>Status:</strong> <span id="previewReason">Loading...</span>
                        </div>
                        <small class="text-muted" id="previewTimestamp"></small>
                    </div>
                </div>

                <div class="d-flex justify-content-end">
                    <button id="executeSimulatedBtn" class="btn btn-success" disabled>
                        Simulate DCA Now
                    </button>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">Transaction History</h5>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>ID</th>
                                <th>Timestamp</th>
                                <th>Status</th>
                                <th>Fiat Amount</th>
                                <th>BTC Amount</th>
                                <th>Price</th>
                                <th>AHR999</th>
                                <th>Notes</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsTable">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
            </div>
        </div>

        <!-- Binance Connection Section (Phase 7) -->
        <div class="card shadow-sm mt-4 mb-5">
            <div class="card-header bg-white d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Binance Connection (Read-Only)</h5>
                <button class="btn btn-sm btn-info text-white" data-bs-toggle="modal" data-bs-target="#binanceHelpModal">
                    ‚ÑπÔ∏è How to get API Key
                </button>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <form id="binanceForm">
                            <div class="mb-3">
                                <label class="form-label">API Key</label>
                                <input type="text" class="form-control" id="apiKey" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">API Secret</label>
                                <input type="password" class="form-control" id="apiSecret" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Save Credentials</button>
                        </form>
                    </div>
                    <div class="col-md-6">
                        <div class="card bg-light h-100">
                            <div class="card-body">
                                <h6>Connection Status</h6>
                                <p id="credStatus">Checking...</p>
                                <button id="testConnectionBtn" class="btn btn-outline-secondary">Test Connection</button>
                                <div id="testResult" class="mt-2 small"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Binance Help Modal -->
    <div class="modal fade" id="binanceHelpModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">How to create a Read-Only API Key</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <ol>
                        <li>Log into your <strong>Binance</strong> account.</li>
                        <li>Go to <strong>API Management</strong> (under Account section in the left sidebar).</li>
                        <li>Click the yellow <strong>Create API</strong> button.</li>
                        <li>In the "Choose API Key type" modal, select <strong>System generated</strong> (HMAC symmetric encryption - this is the default option).</li>
                        <li>Click <strong>Next</strong> and give it a label (e.g. "DCA Read-Only").</li>
                        <li>Complete the security verification.</li>
                        <li><strong>IMPORTANT:</strong> Under "API Restrictions", ensure ONLY <strong>"Enable Reading"</strong> is checked.</li>
                        <li>Uncheck "Enable Spot & Margin Trading" and "Enable Withdrawals".</li>
                        <li>Copy the <strong>API Key</strong> and <strong>Secret Key</strong> immediately.</li>
                        <li>Paste them into the form on this page and click <strong>Save</strong>.</li>
                    </ol>
                    <div class="alert alert-warning small">
                        <strong>Security Note:</strong> Your keys are encrypted before storage. We never display your Secret Key again.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        async function loadTransactions() {
            try {
                const response = await fetch('/api/transactions?limit=50');
                const transactions = await response.json();
                const tbody = document.getElementById('transactionsTable');
                tbody.innerHTML = '';

                transactions.forEach(tx => {
                    const row = document.createElement('tr');
                    const date = new Date(tx.timestamp).toLocaleString();
                    const statusClass = tx.status === 'SUCCESS' ? 'bg-success' : 
                                      tx.status === 'FAILED' ? 'bg-danger' : 'bg-secondary';
                    
                    row.innerHTML = `
                        <td>${tx.id}</td>
                        <td>${date}</td>
                        <td><span class="badge ${statusClass} status-badge">${tx.status}</span></td>
                        <td>$${tx.fiat_amount.toFixed(2)}</td>
                        <td>${tx.btc_amount ? tx.btc_amount.toFixed(8) : '-'}</td>
                        <td>$${tx.price.toFixed(2)}</td>
                        <td>${tx.ahr999.toFixed(4)}</td>
                        <td>${tx.notes || ''}</td>
                    `;
                    tbody.appendChild(row);
                });
            } catch (error) {
                console.error('Error loading transactions:', error);
            }
        }

        document.getElementById('simulateBtn').addEventListener('click', async () => {
            try {
                const response = await fetch('/api/transactions/simulate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        fiat_amount: 100.0,
                        ahr999: 0.45,
                        price: 50000.0,
                        notes: 'Manual simulation'
                    })
                });
                
                if (response.ok) {
                    loadTransactions();
                } else {
                    alert('Simulation failed');
                }
            } catch (error) {
                console.error('Error simulating:', error);
            }
        });

        async function loadPreview() {
            try {
                // Load Strategy for Schedule
                const stratResponse = await fetch('/api/strategy');
                const strategy = await stratResponse.json();
                if (strategy) {
                    const freq = strategy.execution_frequency.charAt(0).toUpperCase() + strategy.execution_frequency.slice(1);
                    document.getElementById('scheduleDisplay').textContent = `Schedule: ${freq} at ${strategy.execution_time_utc} UTC`;
                }

                // Load Preview
                const response = await fetch('/api/dca/preview');
                const decision = await response.json();
                
                // Update metrics display
                document.getElementById('previewAhr').textContent = decision.ahr999_value.toFixed(4);
                document.getElementById('previewPrice').textContent = '$' + decision.price_usd.toLocaleString();
                document.getElementById('previewBand').textContent = decision.ahr_band.toUpperCase();
                document.getElementById('previewAction').textContent = decision.can_execute 
                    ? `BUY $${decision.suggested_amount_usd.toFixed(2)}` 
                    : 'WAIT';
                
                // Update data source (Phase 6)
                const metricsSource = decision.metrics_source || {backend: 'unknown', label: 'Unknown'};
                const sourceBadge = document.getElementById('dataSourceBadge');
                if (sourceBadge) {
                    sourceBadge.textContent = `Source: ${metricsSource.label}`;
                    sourceBadge.title = metricsSource.label; // Tooltip for full label
                }
                
                // Update status
                document.getElementById('previewReason').textContent = decision.reason;
                document.getElementById('previewTimestamp').textContent = 'Last updated: ' + new Date(decision.timestamp).toLocaleTimeString();

                const btn = document.getElementById('executeSimulatedBtn');
                const warningBox = document.getElementById('metricsWarning');

                if (decision.reason.includes("Metrics unavailable") || decision.reason.includes("stale")) {
                    warningBox.classList.remove('d-none');
                    btn.disabled = true;
                    btn.textContent = 'Metrics Error';
                } else {
                    warningBox.classList.add('d-none');
                    if (decision.can_execute) {
                        btn.disabled = false;
                        btn.textContent = `Simulate BUY ($${decision.suggested_amount_usd.toFixed(2)})`;
                    } else {
                        btn.disabled = true;
                        btn.textContent = 'Conditions Not Met';
                    }
                }

            } catch (error) {
                console.error('Error loading preview:', error);
                const reasonElem = document.getElementById('previewReason');
                if (reasonElem) reasonElem.textContent = 'Error loading data';
            }
        }

        // Refresh button handler (Phase 6)
        document.getElementById('refreshBtn').addEventListener('click', async () => {
            const btn = document.getElementById('refreshBtn');
            btn.disabled = true;
            btn.textContent = 'üîÑ Refreshing...';
            
            await loadPreview();
            
            btn.disabled = false;
            btn.textContent = 'üîÑ Refresh';
        });

        document.getElementById('executeSimulatedBtn').addEventListener('click', async () => {
            const btn = document.getElementById('executeSimulatedBtn');
            const originalText = btn.textContent;
            btn.disabled = true;
            btn.textContent = 'Executing...';

            try {
                const response = await fetch('/api/dca/execute-simulated', {
                    method: 'POST'
                });
                const result = await response.json();
                
                if (result.transaction) {
                    alert(`Success! ${result.message}`);
                    // Auto-refresh after successful execution (Phase 6)
                    loadTransactions(); // Refresh history
                    loadPreview();      // Refresh preview (budget might have changed)
                } else {
                    alert(`Skipped: ${result.message}`);
                    // Don't refresh transactions if skipped, but refresh preview to show updated status
                    loadPreview();
                }
            } catch (error) {
                console.error('Error executing simulated DCA:', error);
                alert('Execution failed');
                btn.disabled = false;
                btn.textContent = originalText;
            }
        });

        // Binance Integration (Phase 7)
        async function loadBinanceStatus() {
            try {
                const response = await fetch('/api/binance/credentials/status');
                const status = await response.json();
                
                const statusElem = document.getElementById('credStatus');
                if (status.has_credentials) {
                    statusElem.innerHTML = `<span class="text-success">‚úî Credentials stored</span><br>Key: ${status.masked_api_key}`;
                    document.getElementById('apiKey').placeholder = "Enter new key to update";
                    document.getElementById('apiSecret').placeholder = "Enter new secret to update";
                } else {
                    statusElem.innerHTML = `<span class="text-muted">No credentials saved.</span>`;
                }
            } catch (error) {
                console.error('Error loading binance status:', error);
            }
        }

        async function loadHoldings() {
            try {
                const response = await fetch('/api/binance/holdings');
                const data = await response.json();
                
                const errorBox = document.getElementById('holdingsError');
                const contentBox = document.getElementById('holdingsContent');
                
                if (data.connected) {
                    errorBox.classList.add('d-none');
                    contentBox.classList.remove('d-none');
                    
                    document.getElementById('btcBalance').textContent = data.btc_balance.toFixed(8) + ' BTC';
                    document.getElementById('quoteBalance').textContent = data.quote_balance.toFixed(2);
                    document.getElementById('quoteAsset').textContent = data.quote_asset;
                    
                    const progress = (data.progress_ratio * 100).toFixed(1);
                    document.getElementById('progressPercent').textContent = progress + '%';
                    document.getElementById('targetAmount').textContent = `Target: ${data.target_btc_amount} BTC`;
                    document.getElementById('progressBar').style.width = progress + '%';
                } else {
                    contentBox.classList.add('d-none');
                    errorBox.classList.remove('d-none');
                    if (data.reason === 'no_credentials') {
                        errorBox.textContent = "Binance not connected. Please configure your API key below.";
                    } else {
                        errorBox.textContent = `Connection Error: ${data.reason}`;
                    }
                }
            } catch (error) {
                console.error('Error loading holdings:', error);
            }
        }

        document.getElementById('binanceForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const apiKey = document.getElementById('apiKey').value;
            const apiSecret = document.getElementById('apiSecret').value;
            
            try {
                const response = await fetch('/api/binance/credentials', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ api_key: apiKey, api_secret: apiSecret })
                });
                const result = await response.json();
                
                if (response.ok) {
                    alert(result.message);
                    document.getElementById('apiKey').value = '';
                    document.getElementById('apiSecret').value = '';
                    loadBinanceStatus();
                    loadHoldings();
                } else {
                    alert('Error: ' + result.detail);
                }
            } catch (error) {
                alert('Error saving credentials');
            }
        });

        document.getElementById('testConnectionBtn').addEventListener('click', async () => {
            const resultDiv = document.getElementById('testResult');
            resultDiv.textContent = 'Testing...';
            resultDiv.className = 'mt-2 small text-muted';
            
            try {
                const response = await fetch('/api/binance/test-connection', { method: 'POST' });
                const result = await response.json();
                
                if (result.success) {
                    resultDiv.textContent = '‚úî Connected to Binance (read-only).';
                    resultDiv.className = 'mt-2 small text-success fw-bold';
                    loadHoldings();
                } else {
                    resultDiv.textContent = '‚ùå Connection failed: ' + result.error_message;
                    resultDiv.className = 'mt-2 small text-danger fw-bold';
                }
            } catch (error) {
                resultDiv.textContent = '‚ùå Error testing connection';
                resultDiv.className = 'mt-2 small text-danger';
            }
        });

        // Load on start (Phase 6: auto-refresh on page load)
        loadTransactions();
        loadPreview();
        loadBinanceStatus();
        loadHoldings();
    </script>
</body>
</html>
