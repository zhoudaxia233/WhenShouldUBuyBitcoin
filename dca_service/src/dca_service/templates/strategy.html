<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - Strategy Config</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.css">
    <style>
        body { 
            padding-top: 20px; 
            padding-bottom: 30px;
            background-color: #f8f9fa; 
            min-height: 100vh;
        }
        .container { 
            max-width: 1000px; 
            margin-bottom: 20px;
        }
        
        .percentile-tiers {
            margin-top: 12px;
        }

        .tier-row {
            display: grid;
            grid-template-columns: 2fr 1fr 1.2fr;
            gap: 12px;
            padding: 10px;
            align-items: center;
            border-bottom: 1px solid #e5e5e5;
        }

        .tier-row.tier-header {
            font-weight: 600;
            font-size: 12px;
            text-transform: uppercase;
            color: #86868b;
            background: #f5f5f7;
            border-radius: 6px 6px 0 0;
        }

        .tier-row.tier-header .tier-daily {
            color: #86868b;
            font-size: 12px;
            font-weight: 600;
        }

        .tier-label {
            font-size: 13px;
        }

        .ahr999-range {
            display: block;
            font-size: 11px;
            color: #86868b;
            font-weight: 400;
            margin-top: 4px;
        }

        .tier-multiplier {
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .tier-input {
            width: 80px;
            padding: 6px 8px;
            border: 1px solid #d2d2d7;
            border-radius: 6px;
            font-size: 13px;
        }

        .tier-daily {
            font-size: 13px;
            color: #1d1d1f;
            font-weight: 500;
        }

        .save-button-container {
            margin-top: 0.5rem;
            margin-bottom: 2rem;
            padding-right: 2rem;
        }

        @media (max-width: 768px) {
            .save-button-container {
                padding-right: 0;
                margin-right: 0;
            }
            .save-button-container .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1>{{ project_name }}</h1>
            <a href="/" class="btn btn-outline-secondary">Back to Dashboard</a>
        </header>

        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">DCA Strategy Configuration</h5>
            </div>
            <div class="card-body">
                <form id="strategyForm">
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="is_active">
                        <label class="form-check-label fw-bold" for="is_active">Enable DCA Strategy</label>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="total_budget_usd" class="form-label">Monthly Budget (USD)</label>
                            <input type="number" class="form-control" id="total_budget_usd" step="0.01" required>
                            <div class="form-text text-muted" id="dailyBudgetCalc"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="target_btc_amount" class="form-label">Target BTC Amount</label>
                            <input type="number" class="form-control" id="target_btc_amount" step="0.00000001" value="1.0">
                        </div>
                    </div>

                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enforce_monthly_cap" checked>
                        <label class="form-check-label" for="enforce_monthly_cap">Enforce Monthly Cap</label>
                        <div class="form-text text-muted">Budget resets at the start of each calendar month. Uncheck to allow unlimited spending.</div>
                    </div>

                    <h5 class="mt-4 mb-3">Schedule (UTC)</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Frequency</label>
                            <select class="form-select" id="execution_frequency">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                            </select>
                            
                            <div id="dayOfWeekContainer" class="mt-2 d-none">
                                <label class="form-label small">Day of Week</label>
                                <select class="form-select form-select-sm" id="execution_day_of_week">
                                    <option value="monday">Monday</option>
                                    <option value="tuesday">Tuesday</option>
                                    <option value="wednesday">Wednesday</option>
                                    <option value="thursday">Thursday</option>
                                    <option value="friday">Friday</option>
                                    <option value="saturday">Saturday</option>
                                    <option value="sunday">Sunday</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Time (UTC)</label>
                            <input type="time" class="form-control" id="execution_time_utc" required>
                        </div>
                    </div>

                    <!-- Execution Mode Section (Phase 9) -->
                    <h5 class="mt-4 mb-3">Execution Mode</h5>
                    <div class="mb-3">
                        <div class="form-check">
                            <input class="form-check-input" type="radio" name="execution_mode" id="execution_mode_dry_run" value="DRY_RUN" checked>
                            <label class="form-check-label" for="execution_mode_dry_run">
                                <strong>Dry run only (recommended for now)</strong>
                            </label>
                        </div>
                        <div class="form-text text-muted ps-4">
                            Dry run mode records "virtual" buys only and never sends orders to Binance.
                        </div>
                       
                        <div class="form-check mt-2">
                            <input class="form-check-input" type="radio" name="execution_mode" id="execution_mode_live" value="LIVE" disabled>
                            <label class="form-check-label text-muted" for="execution_mode_live">
                                <strong>Live trading (Binance) <span class="badge bg-secondary">Not implemented yet</span></strong>
                            </label>
                        </div>
                        <div class="form-text text-muted ps-4">
                            Live trading will place real orders on Binance (not implemented yet).
                        </div>
                    </div>

                    <!-- Strategy Logic Section -->

                    <h5 class="mt-4 mb-3">Strategy Logic</h5>
                    
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="strategy_type" class="form-label">Strategy Type</label>
                            <select class="form-select" id="strategy_type">
                                <option value="legacy_band">AHR999 Percentile Strategy</option>
                                <option value="dynamic_ahr999">Dynamic AHR999 Strategy (Advanced)</option>
                            </select>
                            <div class="form-text text-muted">
                                Choose between the percentile-based approach (uses historical AHR999 distribution) or the new continuous curve strategy.
                            </div>
                        </div>
                    </div>

                    <!-- AHR999 Percentile Config Section (6 tiers) -->
                    <div id="legacyConfigSection">
                        <div class="percentile-tiers">
                            <div class="tier-row tier-header">
                                <div class="tier-label">Percentile Range</div>
                                <div class="tier-multiplier">Multiplier</div>
                                <div class="tier-daily">Daily Amount</div>
                            </div>
                            
                            <div class="tier-row">
                                <div class="tier-label">
                                    Bottom 10% (EXTREME CHEAP)
                                    <span class="ahr999-range" id="ahr999-range-p10">(AHR999 &lt; p10)</span>
                                </div>
                                <div class="tier-multiplier">
                                    <input type="number" class="tier-input" id="ahr999_multiplier_p10" value="5" min="0" max="10" step="0.5" placeholder="5.0" oninput="updatePercentileTiers()" />
                                </div>
                                <div class="tier-daily" id="tier-p10-amount">-</div>
                            </div>
                            
                            <div class="tier-row">
                                <div class="tier-label">
                                    10-25% (Very Cheap)
                                    <span class="ahr999-range" id="ahr999-range-p25">(p10 - p25)</span>
                                </div>
                                <div class="tier-multiplier">
                                    <input type="number" class="tier-input" id="ahr999_multiplier_p25" value="2" min="0" max="10" step="0.5" placeholder="2.0" oninput="updatePercentileTiers()" />
                                </div>
                                <div class="tier-daily" id="tier-p25-amount">-</div>
                            </div>
                            
                            <div class="tier-row">
                                <div class="tier-label">
                                    25-50% (Cheap)
                                    <span class="ahr999-range" id="ahr999-range-p50">(p25 - p50)</span>
                                </div>
                                <div class="tier-multiplier">
                                    <input type="number" class="tier-input" id="ahr999_multiplier_p50" value="1" min="0" max="10" step="0.5" placeholder="1.0" oninput="updatePercentileTiers()" />
                                </div>
                                <div class="tier-daily" id="tier-p50-amount">-</div>
                            </div>
                            
                            <div class="tier-row">
                                <div class="tier-label">
                                    50-75% (Fair)
                                    <span class="ahr999-range" id="ahr999-range-p75">(p50 - p75)</span>
                                </div>
                                <div class="tier-multiplier">
                                    <input type="number" class="tier-input" id="ahr999_multiplier_p75" value="0" min="0" max="10" step="0.5" placeholder="0" oninput="updatePercentileTiers()" />
                                </div>
                                <div class="tier-daily" id="tier-p75-amount">-</div>
                            </div>
                            
                            <div class="tier-row">
                                <div class="tier-label">
                                    75-90% (Expensive)
                                    <span class="ahr999-range" id="ahr999-range-p90">(p75 - p90)</span>
                                </div>
                                <div class="tier-multiplier">
                                    <input type="number" class="tier-input" id="ahr999_multiplier_p90" value="0" min="0" max="10" step="0.5" placeholder="0" oninput="updatePercentileTiers()" />
                                </div>
                                <div class="tier-daily" id="tier-p90-amount">-</div>
                            </div>
                            
                            <div class="tier-row">
                                <div class="tier-label">
                                    Top 10% (VERY EXPENSIVE)
                                    <span class="ahr999-range" id="ahr999-range-p100">(AHR999 ≥ p90)</span>
                                </div>
                                <div class="tier-multiplier">
                                    <input type="number" class="tier-input" id="ahr999_multiplier_p100" value="0" min="0" max="10" step="0.5" placeholder="0" oninput="updatePercentileTiers()" />
                                </div>
                                <div class="tier-daily" id="tier-p100-amount">-</div>
                            </div>
                        </div>
                        <div class="alert alert-info mt-3">
                            <strong>Note:</strong> Percentile thresholds (p10, p25, p50, p75, p90) are calculated from historical AHR999 data and update automatically.
                        </div>
                    </div>

                    <!-- Dynamic Config Section -->
                    <div id="dynamicConfigSection" class="d-none">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dynamic_min_multiplier" class="form-label">Min Multiplier</label>
                                <input type="number" class="form-control" id="dynamic_min_multiplier" step="0.1" value="0.0">
                                <div class="form-text text-muted">Floor multiplier when Bitcoin is expensive.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dynamic_max_multiplier" class="form-label">Max Multiplier</label>
                                <input type="number" class="form-control" id="dynamic_max_multiplier" step="0.1" value="10.0">
                                <div class="form-text text-muted">Ceiling multiplier when Bitcoin is cheap.</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dynamic_a_low" class="form-label">Low AHR (Max Buy)</label>
                                <input type="number" class="form-control" id="dynamic_a_low" step="0.01" value="0.45">
                                <div class="form-text text-muted">AHR999 value where buying is maximized.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dynamic_a_high" class="form-label">High AHR (Min Buy)</label>
                                <input type="number" class="form-control" id="dynamic_a_high" step="0.01" value="1.0">
                                <div class="form-text text-muted">AHR999 value where buying stops (or hits min).</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dynamic_gamma" class="form-label">Gamma (Curve Shape)</label>
                                <input type="number" class="form-control" id="dynamic_gamma" step="0.1" value="2.0" min="0.5" max="10.0">
                                <div class="form-text text-muted">
                                    Controls how aggressively to invest when Bitcoin is cheap. 
                                    <strong>Recommended: 1.0-3.0</strong> (2.0 is balanced). 
                                    Lower values (1.0-2.0) = more gradual increase. 
                                    Higher values (3.0-5.0) = only invest heavily when extremely cheap. 
                                    Values &gt; 5.0 are too extreme and not recommended.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Drawdown Boost</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="dynamic_enable_drawdown_boost" checked>
                                    <label class="form-check-label" for="dynamic_enable_drawdown_boost">Enable Drawdown Boost</label>
                                </div>
                                <div class="form-text text-muted">Boosts multiplier up to 2x if price is far below 180-day peak.</div>
                            </div>
                        </div>

                        </div>
                    </div>

                    <div class="save-button-container d-grid gap-2 d-md-flex justify-content-md-end">
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.js"></script>
    <script>
        window.notyf = new Notyf({
            duration: 3000,
            dismissible: true,
            position: { x: 'right', y: 'top' }
        });
    </script>
    <script>
        async function loadStrategy() {
            try {
                const response = await fetch('/api/strategy');
                const strategy = await response.json();
                
                if (strategy) {
                    document.getElementById('is_active').checked = strategy.is_active;
                    document.getElementById('total_budget_usd').value = strategy.total_budget_usd;
                    document.getElementById('enforce_monthly_cap').checked = strategy.enforce_monthly_cap;
                    document.getElementById('target_btc_amount').value = strategy.target_btc_amount;
                    document.getElementById('execution_frequency').value = strategy.execution_frequency || 'daily';
                    document.getElementById('execution_day_of_week').value = strategy.execution_day_of_week || 'monday';
                    document.getElementById('execution_time_utc').value = strategy.execution_time_utc || '00:00';
                    
                    // Strategy Type
                    document.getElementById('strategy_type').value = strategy.strategy_type || 'legacy_band';

                    // Execution Mode (Phase 9)
                    const executionMode = strategy.execution_mode || 'DRY_RUN';
                    if (executionMode === 'LIVE') {
                        document.getElementById('execution_mode_live').checked = true;
                    } else {
                        document.getElementById('execution_mode_dry_run').checked = true;
                    }

                    // Legacy Fields
                    // Load percentile multipliers (6 tiers)
                    // Use existing fields as fallback for backward compatibility
                    document.getElementById('ahr999_multiplier_p10').value = strategy.ahr999_multiplier_p10 || strategy.ahr999_multiplier_low || 5.0;
                    document.getElementById('ahr999_multiplier_p25').value = strategy.ahr999_multiplier_p25 || strategy.ahr999_multiplier_mid || 2.0;
                    document.getElementById('ahr999_multiplier_p50').value = strategy.ahr999_multiplier_p50 || 1.0;
                    document.getElementById('ahr999_multiplier_p75').value = strategy.ahr999_multiplier_p75 || 0.0;
                    document.getElementById('ahr999_multiplier_p90').value = strategy.ahr999_multiplier_p90 || 0.0;
                    document.getElementById('ahr999_multiplier_p100').value = strategy.ahr999_multiplier_p100 || strategy.ahr999_multiplier_high || 0.0;
                    
                    // Dynamic Fields
                    document.getElementById('dynamic_min_multiplier').value = strategy.dynamic_min_multiplier !== null ? strategy.dynamic_min_multiplier : 0.0;
                    document.getElementById('dynamic_max_multiplier').value = strategy.dynamic_max_multiplier !== null ? strategy.dynamic_max_multiplier : 10.0;
                    document.getElementById('dynamic_gamma').value = strategy.dynamic_gamma !== null ? strategy.dynamic_gamma : 2.0;
                    document.getElementById('dynamic_a_low').value = strategy.dynamic_a_low !== null ? strategy.dynamic_a_low : 0.45;
                    document.getElementById('dynamic_a_high').value = strategy.dynamic_a_high !== null ? strategy.dynamic_a_high : 1.0;
                    document.getElementById('dynamic_enable_drawdown_boost').checked = strategy.dynamic_enable_drawdown_boost !== null ? strategy.dynamic_enable_drawdown_boost : true;
                    
                    // Trigger updates
                    updateDailyCalc();
                    toggleDayOfWeek();
                    toggleStrategyType();
                    loadPercentileThresholds();
                }
            } catch (error) {
                console.error('Error loading strategy:', error);
            }
        }

        document.getElementById('strategyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                is_active: document.getElementById('is_active').checked,
                total_budget_usd: parseFloat(document.getElementById('total_budget_usd').value),
                enforce_monthly_cap: document.getElementById('enforce_monthly_cap').checked,
                target_btc_amount: parseFloat(document.getElementById('target_btc_amount').value),
                execution_frequency: document.getElementById('execution_frequency').value,
                execution_day_of_week: document.getElementById('execution_frequency').value === 'weekly' ? document.getElementById('execution_day_of_week').value : null,
                execution_time_utc: document.getElementById('execution_time_utc').value,
                
                // Strategy Type
                strategy_type: document.getElementById('strategy_type').value,
                
                // Execution Mode (Phase 9)
                execution_mode: document.querySelector('input[name="execution_mode"]:checked').value,
                
                // Legacy Fields
                // Save percentile multipliers (6 tiers)
                // For backward compatibility, also save to old fields
                ahr999_multiplier_p10: parseFloat(document.getElementById('ahr999_multiplier_p10').value) || 5.0,
                ahr999_multiplier_p25: parseFloat(document.getElementById('ahr999_multiplier_p25').value) || 2.0,
                ahr999_multiplier_p50: parseFloat(document.getElementById('ahr999_multiplier_p50').value) || 1.0,
                ahr999_multiplier_p75: parseFloat(document.getElementById('ahr999_multiplier_p75').value) || 0.0,
                ahr999_multiplier_p90: parseFloat(document.getElementById('ahr999_multiplier_p90').value) || 0.0,
                ahr999_multiplier_p100: parseFloat(document.getElementById('ahr999_multiplier_p100').value) || 0.0,
                // Backward compatibility: map to old fields
                ahr999_multiplier_low: parseFloat(document.getElementById('ahr999_multiplier_p10').value) || 5.0,
                ahr999_multiplier_mid: parseFloat(document.getElementById('ahr999_multiplier_p25').value) || 2.0,
                ahr999_multiplier_high: parseFloat(document.getElementById('ahr999_multiplier_p100').value) || 0.0,
                
                // Dynamic Fields
                dynamic_min_multiplier: parseFloat(document.getElementById('dynamic_min_multiplier').value),
                dynamic_max_multiplier: parseFloat(document.getElementById('dynamic_max_multiplier').value),
                dynamic_gamma: parseFloat(document.getElementById('dynamic_gamma').value),
                dynamic_a_low: parseFloat(document.getElementById('dynamic_a_low').value),
                dynamic_a_high: parseFloat(document.getElementById('dynamic_a_high').value),
                dynamic_enable_drawdown_boost: document.getElementById('dynamic_enable_drawdown_boost').checked
            };

            try {
                const response = await fetch('/api/strategy', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    notyf.success('Strategy updated');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    notyf.error('Error saving strategy');
                }
            } catch (error) {
                console.error('Error saving strategy:', error);
                notyf.error('Network error or backend unreachable');
            }
        });



        // UX Enhancements
        function updateDailyCalc() {
            const total = parseFloat(document.getElementById('total_budget_usd').value) || 0;
            const DAYS_PER_MONTH = 30.44; // Average days per month (same as backtest)
            const daily = total / DAYS_PER_MONTH;
            const helpText = document.getElementById('dailyBudgetCalc');
            if (total > 0) {
                helpText.textContent = `Estimated Daily Amount: $${daily.toFixed(2)} (assuming monthly budget)`;
            } else {
                helpText.textContent = '';
            }
            updatePercentileTiers();
        }

        function updatePercentileTiers() {
            const monthlyBudget = parseFloat(document.getElementById('total_budget_usd').value) || 0;
            const dailyBudget = monthlyBudget / 30.44; // Days per month
            
            const tiers = [
                { id: 'p10', multiplierId: 'ahr999_multiplier_p10', amountId: 'tier-p10-amount' },
                { id: 'p25', multiplierId: 'ahr999_multiplier_p25', amountId: 'tier-p25-amount' },
                { id: 'p50', multiplierId: 'ahr999_multiplier_p50', amountId: 'tier-p50-amount' },
                { id: 'p75', multiplierId: 'ahr999_multiplier_p75', amountId: 'tier-p75-amount' },
                { id: 'p90', multiplierId: 'ahr999_multiplier_p90', amountId: 'tier-p90-amount' },
                { id: 'p100', multiplierId: 'ahr999_multiplier_p100', amountId: 'tier-p100-amount' },
            ];
            
            tiers.forEach(tier => {
                const multiplier = parseFloat(document.getElementById(tier.multiplierId).value) || 0;
                const amount = dailyBudget * multiplier;
                const amountElement = document.getElementById(tier.amountId);
                if (amountElement) {
                    amountElement.textContent = `$${amount.toFixed(2)}/day`;
                }
            });
        }

        async function loadPercentileThresholds() {
            try {
                const response = await fetch('/api/metrics/percentiles');
                if (response.ok) {
                    const data = await response.json();
                    // Update AHR999 range displays
                    if (data.p10 !== undefined) {
                        document.getElementById('ahr999-range-p10').textContent = `(AHR999 < ${data.p10.toFixed(2)})`;
                    }
                    if (data.p25 !== undefined) {
                        document.getElementById('ahr999-range-p25').textContent = `(${data.p10?.toFixed(2) || 'p10'} - ${data.p25.toFixed(2)})`;
                    }
                    if (data.p50 !== undefined) {
                        document.getElementById('ahr999-range-p50').textContent = `(${data.p25?.toFixed(2) || 'p25'} - ${data.p50.toFixed(2)})`;
                    }
                    if (data.p75 !== undefined) {
                        document.getElementById('ahr999-range-p75').textContent = `(${data.p50?.toFixed(2) || 'p50'} - ${data.p75.toFixed(2)})`;
                    }
                    if (data.p90 !== undefined) {
                        document.getElementById('ahr999-range-p90').textContent = `(${data.p75?.toFixed(2) || 'p75'} - ${data.p90.toFixed(2)})`;
                    }
                    if (data.p90 !== undefined) {
                        document.getElementById('ahr999-range-p100').textContent = `(AHR999 ≥ ${data.p90.toFixed(2)})`;
                    }
                }
            } catch (error) {
                console.error('Error loading percentile thresholds:', error);
            }
        }

        function toggleDayOfWeek() {
            const freq = document.getElementById('execution_frequency').value;
            const container = document.getElementById('dayOfWeekContainer');
            if (freq === 'weekly') {
                container.classList.remove('d-none');
            } else {
                container.classList.add('d-none');
            }
        }
        
        function toggleStrategyType() {
            const type = document.getElementById('strategy_type').value;
            const legacySection = document.getElementById('legacyConfigSection');
            const dynamicSection = document.getElementById('dynamicConfigSection');
            
            if (type === 'dynamic_ahr999') {
                legacySection.classList.add('d-none');
                dynamicSection.classList.remove('d-none');
            } else {
                legacySection.classList.remove('d-none');
                dynamicSection.classList.add('d-none');
            }
        }
        


        document.getElementById('total_budget_usd').addEventListener('input', updateDailyCalc);
        document.getElementById('execution_frequency').addEventListener('change', toggleDayOfWeek);
        document.getElementById('strategy_type').addEventListener('change', toggleStrategyType);

        // Load strategy and percentile thresholds on page load
        loadStrategy();
        loadPercentileThresholds();
    </script>
</body>
</html>
