<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ project_name }} - Strategy Config</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.css">
    <style>
        body { padding-top: 20px; background-color: #f8f9fa; }
        .container { max-width: 800px; }
    </style>
</head>
<body>
    <div class="container">
        <header class="d-flex justify-content-between align-items-center mb-4">
            <h1>{{ project_name }}</h1>
            <a href="/" class="btn btn-outline-secondary">Back to Dashboard</a>
        </header>

        <div class="card shadow-sm">
            <div class="card-header bg-white">
                <h5 class="mb-0">DCA Strategy Configuration</h5>
            </div>
            <div class="card-body">
                <form id="strategyForm">
                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="is_active">
                        <label class="form-check-label fw-bold" for="is_active">Enable DCA Strategy</label>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label for="total_budget_usd" class="form-label">Monthly Budget (USD)</label>
                            <input type="number" class="form-control" id="total_budget_usd" step="0.01" required>
                            <div class="form-text text-muted" id="dailyBudgetCalc"></div>
                        </div>
                        <div class="col-md-6">
                            <label for="target_btc_amount" class="form-label">Target BTC Amount</label>
                            <input type="number" class="form-control" id="target_btc_amount" step="0.00000001" value="1.0">
                        </div>
                    </div>

                    <div class="mb-3 form-check form-switch">
                        <input class="form-check-input" type="checkbox" id="enforce_monthly_cap" checked>
                        <label class="form-check-label" for="enforce_monthly_cap">Enforce Monthly Cap</label>
                        <div class="form-text text-muted">Budget resets at the start of each calendar month. Uncheck to allow unlimited spending.</div>
                    </div>

                    <h5 class="mt-4 mb-3">Schedule (UTC)</h5>
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Frequency</label>
                            <select class="form-select" id="execution_frequency">
                                <option value="daily">Daily</option>
                                <option value="weekly">Weekly</option>
                            </select>
                            
                            <div id="dayOfWeekContainer" class="mt-2 d-none">
                                <label class="form-label small">Day of Week</label>
                                <select class="form-select form-select-sm" id="execution_day_of_week">
                                    <option value="monday">Monday</option>
                                    <option value="tuesday">Tuesday</option>
                                    <option value="wednesday">Wednesday</option>
                                    <option value="thursday">Thursday</option>
                                    <option value="friday">Friday</option>
                                    <option value="saturday">Saturday</option>
                                    <option value="sunday">Sunday</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label class="form-label">Time (UTC)</label>
                            <input type="time" class="form-control" id="execution_time_utc" required>
                        </div>
                    </div>

                    <!-- Strategy Logic Section -->
                    <h5 class="mt-4 mb-3">Strategy Logic</h5>
                    
                    <div class="row">
                        <div class="col-12 mb-3">
                            <label for="strategy_type" class="form-label">Strategy Type</label>
                            <select class="form-select" id="strategy_type">
                                <option value="legacy_band">Legacy Band Strategy (Simple)</option>
                                <option value="dynamic_ahr999">Dynamic AHR999 Strategy (Advanced)</option>
                            </select>
                            <div class="form-text text-muted">
                                Choose between the classic band-based approach or the new continuous curve strategy.
                            </div>
                        </div>
                    </div>

                    <!-- Legacy Config Section -->
                    <div id="legacyConfigSection">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="ahr999_multiplier_low" class="form-label">Low Multiplier (< 0.45)</label>
                                <input type="number" class="form-control" id="ahr999_multiplier_low" step="0.1">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="ahr999_multiplier_mid" class="form-label">Mid Multiplier (0.45 - 1.2)</label>
                                <input type="number" class="form-control" id="ahr999_multiplier_mid" step="0.1">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="ahr999_multiplier_high" class="form-label">High Multiplier (> 1.2)</label>
                                <input type="number" class="form-control" id="ahr999_multiplier_high" step="0.1">
                            </div>
                        </div>
                    </div>

                    <!-- Dynamic Config Section -->
                    <div id="dynamicConfigSection" class="d-none">
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dynamic_min_multiplier" class="form-label">Min Multiplier</label>
                                <input type="number" class="form-control" id="dynamic_min_multiplier" step="0.1" value="0.0">
                                <div class="form-text text-muted">Floor multiplier when Bitcoin is expensive.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dynamic_max_multiplier" class="form-label">Max Multiplier</label>
                                <input type="number" class="form-control" id="dynamic_max_multiplier" step="0.1" value="10.0">
                                <div class="form-text text-muted">Ceiling multiplier when Bitcoin is cheap.</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dynamic_a_low" class="form-label">Low AHR (Max Buy)</label>
                                <input type="number" class="form-control" id="dynamic_a_low" step="0.01" value="0.45">
                                <div class="form-text text-muted">AHR999 value where buying is maximized.</div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="dynamic_a_high" class="form-label">High AHR (Min Buy)</label>
                                <input type="number" class="form-control" id="dynamic_a_high" step="0.01" value="1.0">
                                <div class="form-text text-muted">AHR999 value where buying stops (or hits min).</div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="dynamic_gamma" class="form-label">Gamma (Curve Shape)</label>
                                <input type="number" class="form-control" id="dynamic_gamma" step="0.1" value="2.0" min="0.5" max="10.0">
                                <div class="form-text text-muted">
                                    Controls how aggressively to invest when Bitcoin is cheap. 
                                    <strong>Recommended: 1.0-3.0</strong> (2.0 is balanced). 
                                    Lower values (1.0-2.0) = more gradual increase. 
                                    Higher values (3.0-5.0) = only invest heavily when extremely cheap. 
                                    Values &gt; 5.0 are too extreme and not recommended.
                                </div>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Drawdown Boost</label>
                                <div class="form-check form-switch mt-2">
                                    <input class="form-check-input" type="checkbox" id="dynamic_enable_drawdown_boost" checked>
                                    <label class="form-check-label" for="dynamic_enable_drawdown_boost">Enable Drawdown Boost</label>
                                </div>
                                <div class="form-text text-muted">Boosts multiplier up to 2x if price is far below 180-day peak.</div>
                            </div>
                        </div>

                        </div>
                    </div>

                    <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/notyf@3.10.0/notyf.min.js"></script>
    <script>
        window.notyf = new Notyf({
            duration: 3000,
            dismissible: true,
            position: { x: 'right', y: 'top' }
        });
    </script>
    <script>
        async function loadStrategy() {
            try {
                const response = await fetch('/api/strategy');
                const strategy = await response.json();
                
                if (strategy) {
                    document.getElementById('is_active').checked = strategy.is_active;
                    document.getElementById('total_budget_usd').value = strategy.total_budget_usd;
                    document.getElementById('enforce_monthly_cap').checked = strategy.enforce_monthly_cap;
                    document.getElementById('target_btc_amount').value = strategy.target_btc_amount;
                    document.getElementById('execution_frequency').value = strategy.execution_frequency || 'daily';
                    document.getElementById('execution_day_of_week').value = strategy.execution_day_of_week || 'monday';
                    document.getElementById('execution_time_utc').value = strategy.execution_time_utc || '00:00';
                    
                    // Strategy Type
                    document.getElementById('strategy_type').value = strategy.strategy_type || 'legacy_band';

                    // Legacy Fields
                    document.getElementById('ahr999_multiplier_low').value = strategy.ahr999_multiplier_low;
                    document.getElementById('ahr999_multiplier_mid').value = strategy.ahr999_multiplier_mid;
                    document.getElementById('ahr999_multiplier_high').value = strategy.ahr999_multiplier_high;
                    
                    // Dynamic Fields
                    document.getElementById('dynamic_min_multiplier').value = strategy.dynamic_min_multiplier !== null ? strategy.dynamic_min_multiplier : 0.0;
                    document.getElementById('dynamic_max_multiplier').value = strategy.dynamic_max_multiplier !== null ? strategy.dynamic_max_multiplier : 10.0;
                    document.getElementById('dynamic_gamma').value = strategy.dynamic_gamma !== null ? strategy.dynamic_gamma : 2.0;
                    document.getElementById('dynamic_a_low').value = strategy.dynamic_a_low !== null ? strategy.dynamic_a_low : 0.45;
                    document.getElementById('dynamic_a_high').value = strategy.dynamic_a_high !== null ? strategy.dynamic_a_high : 1.0;
                    document.getElementById('dynamic_enable_drawdown_boost').checked = strategy.dynamic_enable_drawdown_boost !== null ? strategy.dynamic_enable_drawdown_boost : true;
                    
                    // Trigger updates
                    updateDailyCalc();
                    toggleDayOfWeek();
                    toggleStrategyType();
                }
            } catch (error) {
                console.error('Error loading strategy:', error);
            }
        }

        document.getElementById('strategyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const data = {
                is_active: document.getElementById('is_active').checked,
                total_budget_usd: parseFloat(document.getElementById('total_budget_usd').value),
                enforce_monthly_cap: document.getElementById('enforce_monthly_cap').checked,
                target_btc_amount: parseFloat(document.getElementById('target_btc_amount').value),
                execution_frequency: document.getElementById('execution_frequency').value,
                execution_day_of_week: document.getElementById('execution_frequency').value === 'weekly' ? document.getElementById('execution_day_of_week').value : null,
                execution_time_utc: document.getElementById('execution_time_utc').value,
                
                // Strategy Type
                strategy_type: document.getElementById('strategy_type').value,
                
                // Legacy Fields
                ahr999_multiplier_low: parseFloat(document.getElementById('ahr999_multiplier_low').value) || 0,
                ahr999_multiplier_mid: parseFloat(document.getElementById('ahr999_multiplier_mid').value) || 0,
                ahr999_multiplier_high: parseFloat(document.getElementById('ahr999_multiplier_high').value) || 0,
                
                // Dynamic Fields
                dynamic_min_multiplier: parseFloat(document.getElementById('dynamic_min_multiplier').value),
                dynamic_max_multiplier: parseFloat(document.getElementById('dynamic_max_multiplier').value),
                dynamic_gamma: parseFloat(document.getElementById('dynamic_gamma').value),
                dynamic_a_low: parseFloat(document.getElementById('dynamic_a_low').value),
                dynamic_a_high: parseFloat(document.getElementById('dynamic_a_high').value),
                dynamic_enable_drawdown_boost: document.getElementById('dynamic_enable_drawdown_boost').checked
            };

            try {
                const response = await fetch('/api/strategy', {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });
                
                if (response.ok) {
                    notyf.success('Strategy updated');
                    setTimeout(() => {
                        window.location.href = '/';
                    }, 1000);
                } else {
                    notyf.error('Error saving strategy');
                }
            } catch (error) {
                console.error('Error saving strategy:', error);
                notyf.error('Network error or backend unreachable');
            }
        });



        // UX Enhancements
        function updateDailyCalc() {
            const total = parseFloat(document.getElementById('total_budget_usd').value) || 0;
            const daily = total / 30.0; // Approximate
            const helpText = document.getElementById('dailyBudgetCalc');
            if (total > 0) {
                helpText.textContent = `Estimated Daily Amount: $${daily.toFixed(2)} (assuming monthly budget)`;
            } else {
                helpText.textContent = '';
            }
        }

        function toggleDayOfWeek() {
            const freq = document.getElementById('execution_frequency').value;
            const container = document.getElementById('dayOfWeekContainer');
            if (freq === 'weekly') {
                container.classList.remove('d-none');
            } else {
                container.classList.add('d-none');
            }
        }
        
        function toggleStrategyType() {
            const type = document.getElementById('strategy_type').value;
            const legacySection = document.getElementById('legacyConfigSection');
            const dynamicSection = document.getElementById('dynamicConfigSection');
            
            if (type === 'dynamic_ahr999') {
                legacySection.classList.add('d-none');
                dynamicSection.classList.remove('d-none');
            } else {
                legacySection.classList.remove('d-none');
                dynamicSection.classList.add('d-none');
            }
        }
        


        document.getElementById('total_budget_usd').addEventListener('input', updateDailyCalc);
        document.getElementById('execution_frequency').addEventListener('change', toggleDayOfWeek);
        document.getElementById('strategy_type').addEventListener('change', toggleStrategyType);

        loadStrategy();
    </script>
</body>
</html>
